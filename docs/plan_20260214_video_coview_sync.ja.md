# 実装設計書: 動画共体験用同期キャプチャ機能 (Video Co-view Sync)

## 1. 目的
LLM がユーザーと同じ動画を「リアルタイムで一緒に見ている」状態を実現するため、映像フレームと音声文字起こしを共通のタイムライン（経過時間）で同期させ、一つのパッケージとして通知する機能を実装する。

## 2. 仕様概要
- **ツール名**: `watch_video_v2` (既存の v1 プロトタイプを正式版として再設計)
- **基本動作**:
    - 指定したインターバル（デフォルト 2000ms）ごとに以下の処理を行う。
    - **映像**: 指定ウィンドウまたは領域のスクリーンショットをキャプチャ。
    - **音声**: 同じ 2000ms 間のシステム音をバックグラウンドで録音。
    - **同期**: キャプチャした映像と、録音・文字起こししたテキストを同一の `ts` (RelativeTime) を付与して通知。
- **データ形式 (MCP Notification)**:
    - `type`: `"video_coview"`
    - `ts`: セッション開始からの経過秒数 (float, 精度 100ms)
    - `frame`: JPEG base64 (改行・空白を完全に除去)
    - `transcript`: 当該区間の文字起こしテキスト
    - `windowTitle`: 取得時のウィンドウタイトル

---

## 3. 実装詳細

### 3.1 映像・音声の同期制御
- `System.Timers.Timer` または `Task.Delay` を使用した一定間隔のループを構築する。
- 音声録音 (`AudioCaptureService`) と映像キャプチャ (`ScreenCaptureService`) を並列で開始。
- 文字起こし (`WhisperTranscriptionService`) は非同期で実行し、次のフレームキャプチャをブロックしないように制御する。

### 3.2 base64 データの正規化
- 以前のフィードバック (`docs/feedback_20240614_base64_input_handling.md`) に基づき、出力直前に必ず以下の処理を行う。
  ```csharp
  base64Data = base64Data.Replace("
", "").Replace("", "").Replace(" ", "");
  ```

### 3.3 タイムスタンプ管理
- セッション開始時の `DateTime.UtcNow` を基準 (`ts = 0.0`) とし、各キャプチャタイミングの経過時間を計算する。
- 音声の文字起こし結果が遅れて完了した場合も、元のキャプチャ時刻 `ts` を保持して通知を送信する。

---

## 4. 既存コードへの修正・追加箇所

### `src/WindowsDesktopUse.App/DesktopUseTools.cs`
- `watch_video_v2` ツールを追加。
- 内部で `Task.Run` を使用し、映像と音声のバッチ処理を行うパイプラインを実装。

### `src/WindowsDesktopUse.Core/Models.cs`
- 同期通知用のデータ構造 `VideoCoViewPayload` を追加。

---

## 5. 技術的制約と注意点
- **OCR**: 今回のフェーズでは字幕 OCR は実装しない。
- **負荷**: 2秒間隔の文字起こしは CPU 負荷が高いため、デフォルトモデルを `tiny` または `base` に設定し、LLM にモデル選択を委ねる。
- **ログ**: `Console.Error.WriteLine` を使用し、パイプラインの状態（キャプチャ完了、文字起こし完了等）を stderr に出力する。

---

## 6. 受入基準 (Acceptance Criteria)
1. `watch_video_v2` を開始すると、約 2秒ごとに映像とテキストがペアになった通知が届くこと。
2. `ts` が 0.0, 2.0, 4.0... と規則正しくインクリメントされていること。
3. 送信される base64 文字列に改行コードが含まれていないこと。
4. ウィンドウを閉じたり、ツールを停止した際に、録音とキャプチャが安全に終了すること。
