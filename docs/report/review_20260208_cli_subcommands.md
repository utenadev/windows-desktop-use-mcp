# CLI サブコマンド機能の実装レビュー報告書 (2026-02-08)

## 1. 概要
`WindowsDesktopUse.App` に対し、`System.CommandLine` を利用したサブコマンド（`doctor`, `setup`, `whisper`）が実装されました。これにより、インストール後のトラブルシューティングや設定が容易になりました。

## 2. レビュー結果サマリー

| 項目 | 評価 | 備考 |
| :--- | :--- | :--- |
| **利便性** | 🟢 優秀 | `setup` による自動設定、`doctor` による環境診断が非常に有用。 |
| **実装品質** | 🟢 優良 | `System.CommandLine` を適切に利用。日本語/英語のローカライズ対応も良好。 |
| **互換性** | 🟢 合格 | サブコマンドなしで実行した場合の MCP サーバーとしての動作が維持されている。 |
| **堅牢性** | 🟡 良好 | `setup` の設定マージ処理など、既存環境を破壊しない工夫が見られる。 |

---

## 3. 詳細レビュー

### 3.1. `doctor` コマンド（システム診断）
- **機能**: OSバージョン、.NETランタイム、モニター認識、オーディオデバイス、Whisperモデルの存在を包括的にチェック。
- **評価**: 初心者が「なぜ動かないか」を自己解決するためのツールとして非常に強力です。`--json` フラグにより、他のツールからの利用も考慮されています。
- **技術的ポイント**: `SetProcessDPIAware()` を呼び出した上でモニターチェックを行っており、実動作に近い環境で診断が行われています。

### 3.2. `setup` コマンド（自動設定）
- **機能**: `%AppData%\Roaming\Claude\claude_desktop_config.json` を自動的に書き換え、本サーバーを登録。
- **評価**: これまで手動で行っていた JSON 編集がコマンド一つで完了するようになり、導入の摩擦が最小化されました。
- **安全策**: 既存の `mcpServers` 設定を保持したまま自身の項目のみを追加・更新するマージ処理が実装されており、安全性が高いです。

### 3.3. `whisper` コマンド（モデル管理）
- **機能**: 利用可能なモデルサイズの一覧と、ローカルにインストール済みのモデルを表示。
- **評価**: Whisper.net の大きな特徴である「モデル選択」をユーザーが把握しやすくなりました。

### 3.4. アーキテクチャとローカライズ
- **実装**: `Program.cs` において、`CultureInfo` を参照した簡易的なローカライズ機構が導入されており、日本語環境のユーザーへの配慮がなされています。
- **MCP サーバーとの共存**: ルートコマンドのハンドラとして従来のサーバー起動処理が定義されているため、引数なし（または従来のオプションのみ）で実行した際の MCP サーバーとしての挙動は損なわれていません。

---

## 4. 今後の改善提案

### 4.1. `whisper download` の実装 (優先度: 低)
現在、モデルのダウンロードは `listen` ツールの初回使用時に自動で行われますが、CLI から明示的に `whisper download base` のように事前ダウンロードできる機能があると、さらに親切です。

### 4.2. `doctor` における管理者権限のチェック (優先度: 中)
オーディオデバイス取得などで失敗した場合、「管理者権限で実行してください」というアドバイスを明確に出力するロジックを強化すると、よりトラブルシューティングがスムーズになります。

## 5. 結論
今回の機能追加により、本プロジェクトは「開発者向けのプロトタイプ」から「一般ユーザーが利用可能な製品レベル」へと一段階進化したと言えます。コードの構造も整理されており、保守性の面でも問題ありません。
