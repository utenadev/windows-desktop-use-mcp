# デスクトップ操作セキュリティ強化計画書レビュー (2026-02-08)

## 1. 概要
`docs/report/plan_20260208_safe_input.md` に基づく、AIによるデスクトップ操作のセキュリティ強化と安全な入力実装の計画書をレビューしました。

## 2. レビュー結果サマリー

| 項目 | 評価 | 備考 |
| :--- | :--- | :--- |
| **セキュリティ設計** | 🟢 優良 | 三原則（Direct Control/Target Isolation/Strict Filtering）が明確に定義されている。 |
| **技術的アプローチ** | 🟢 優良 | UI Automation (UIA) と Win32 API の使い分けが適切。 |
| **実装方針** | 🟡 良好 | フェーズ分けは適切だが、フォールバック戦略の詳細が不足。 |
| **リスク管理** | 🟢 優良 | 懸念点と対策が具体的に記載されている。 |

---

## 3. 詳細レビュー

### 3.1. セキュリティ設計の三原則
- **Direct Control**: `SendInput` から UI Automation API への移行を推奨。キー入力シミュレーションではなく、直接的な値設定で誤爆リスクを低減。
- **Target Isolation**: `GetForegroundWindow()` によるフォーカス検証は効果的。ウィンドウ切り替えによる予期せぬ入力を防止。
- **Strict Filtering**: 禁止キー（Win/Alt/Ctrl等）と許可キー（Tab/Enter/Arrow等）の区別が明確。

### 3.2. 新規ツールセット
計画書で提案されているツール群は、既存の `mouse_*`, `keyboard_*` に代わる安全な代替手段として適切：

| ツール名 | 評価 | コメント |
| :--- | :--- | :--- |
| `move_window` | 🟢 | Win32 API で実装容易。安全。 |
| `click_element` | 🟢 | UIA による要素指定は座標より堅牢。 |
| `set_input_text` | 🟢 | `ValuePattern` による直接書き込みが最も安全。 |
| `send_nav_key` | 🟡 | ホワイトリスト制限は有効だが、Tab連打対策は必須。 |

### 3.3. 技術的アプローチ
- **UI Automation**: .NET の `UIAutomationClient` は標準ライブラリであり、追加コストなしで導入可能。
- **ハイブリッド入力**: 3段階のフォールバック（UIA → WM_SETTEXT → 制限付きSendInput）は実用的。

---

## 4. 改善提案・指摘事項

### 4.1. UIA 非対応アプリの扱い (優先度: 高)
ブラウザやゲーム等、UIAに対応していないアプリケーションへの対応が計画書には記載されているが、具体的な実装方針が不明確です。

**提案**:
- UIA非対応検出時のエラーメッセージを標準化
- 「セーフモード外操作」フラグを導入し、ユーザー（AI）に明示的な許可を求めるフローを設計

### 4.2. ウィンドウ・ロックの永続性 (優先度: 中)
`set_target_window(hwnd)` で設定したロックが、操作実行中にウィンドウが閉じられた場合の挙動が未定義です。

**提案**:
- 操作実行直前の `IsWindow()` 検証を追加
- ウィンドウ消失時のエラーハンドリングを定義

### 4.3. 移行期間の並行運用 (優先度: 低)
既存ツールと新ツールの並行運用期間について言及がない。

**提案**:
- 既存 `keyboard_*` ツールを「レガシーモード」として一定期間維持
- 設定ファイル (`appsettings.json`) で動作モードを切り替え可能にする

---

## 5. 結論
本計画書は、AIによるデスクトップ操作における重大なセキュリティリスクを体系的に排除するための優れた設計です。

特に以下の点が評価できる：
- オブジェクト指向の操作への転換（座標→要素）
- 厳格なキー入力制限
- フォーカス検証による誤爆防止

UIA非対応アプリの扱いを具体化し、移行戦略を明確にすることで、より実装可能な計画となるでしょう。

---

## 6. 関連ドキュメント
- [リファクタリング計画](./plan_20260207_refactoring.md)
- [Geminiレビュー報告書](./review_20260207_gemini.md)
- [安全な入力実装計画](./plan_20260208_safe_input.md) (本計画書)
